<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mes abonnements - Smart Parking</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav>
        <div class="logo">Smart Parking</div>
        <ul>
            <li><a href="index.html">Rechercher</a></li>
            <li><a href="my-reservations.html">Mes réservations</a></li>
            <li><a href="my-subscriptions.html">Mes abonnements</a></li>
            <li><a href="#" id="logout-btn">Déconnexion</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="card">
            <h2>Mes abonnements</h2>

            <div id="alert-container"></div>

            <div id="loading" class="loading" style="display: none;">
                <div class="spinner"></div>
                <p>Chargement de vos abonnements...</p>
            </div>

            <div id="subscriptions-container"></div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        if (!authAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        const user = authAPI.getUser();
        const alertContainer = document.getElementById('alert-container');
        const subscriptionsContainer = document.getElementById('subscriptions-container');
        const loadingDiv = document.getElementById('loading');

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            authAPI.logout();
        });

        function showAlert(message, type = 'info') {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        async function loadSubscriptions() {
            loadingDiv.style.display = 'block';

            try {
                const response = await subscriptionAPI.getUserSubscriptions(user.id);
                displaySubscriptions(response.subscriptions || []);
            } catch (error) {
                showAlert('Erreur lors du chargement des abonnements', 'error');
                subscriptionsContainer.innerHTML = '<p>Aucun abonnement trouvé</p>';
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displaySubscriptions(subscriptions) {
            if (subscriptions.length === 0) {
                subscriptionsContainer.innerHTML = `
                    <p style="text-align: center; color: #666;">
                        Vous n'avez aucun abonnement actif
                    </p>
                    <a href="index.html" class="btn btn-primary btn-block">
                        Rechercher un parking
                    </a>
                `;
                return;
            }

            const html = subscriptions.map(sub => `
                <div class="parking-card" style="margin-bottom: 1rem;">
                    <div style="display: flex; justify-content: space-between; align-items: start;">
                        <div style="flex: 1;">
                            <h3>${sub.parking_name || 'Parking'}</h3>
                            <p><strong>Type:</strong> ${getSubscriptionTypeName(sub.type)}</p>
                            <p><strong>Durée:</strong> ${getDurationFromDates(sub.start_date, sub.end_date)}</p>
                            <p><strong>Début:</strong> ${formatDate(sub.start_date)}</p>
                            <p><strong>Fin:</strong> ${formatDate(sub.end_date)}</p>
                            <p><strong>Prix payé:</strong> ${sub.price || 'N/A'}€</p>

                            <div style="margin-top: 0.5rem; padding: 0.5rem; background: #f8f9fa; border-radius: 4px;">
                                <strong>Créneaux horaires:</strong>
                                ${formatTimeSlots(sub.time_slots)}
                            </div>

                            <span class="status-badge status-${sub.is_active ? 'active' : 'expired'}" style="margin-top: 0.5rem; display: inline-block;">
                                ${sub.is_active ? 'Actif' : 'Expiré'}
                            </span>
                        </div>
                        <div>
                            ${sub.is_active ? `
                                <a href="parking-details.html?id=${sub.parking_id}" class="btn btn-primary">
                                    Voir le parking
                                </a>
                            ` : ''}
                        </div>
                    </div>
                </div>
            `).join('');

            subscriptionsContainer.innerHTML = html;
        }

        function getSubscriptionTypeName(type) {
            const types = {
                'monthly': 'Mensuel Total',
                'weekend': 'Week-end',
                'evening': 'Soirée',
                'custom': 'Personnalisé',
                'quarterly': 'Trimestriel',
                'yearly': 'Annuel'
            };
            return types[type] || type || 'Standard';
        }

        function getDurationFromDates(startTimestamp, endTimestamp) {
            if (!startTimestamp || !endTimestamp) return 'N/A';
            const days = Math.floor((endTimestamp - startTimestamp) / (60 * 60 * 24));
            if (days >= 365) return `${Math.floor(days / 365)} an(s)`;
            if (days >= 30) return `${Math.floor(days / 30)} mois`;
            return `${days} jours`;
        }

        function formatTimeSlots(slots) {
            if (!slots) return '<p style="margin: 0.25rem 0;">Accès illimité 24h/24, 7j/7</p>';

            if (typeof slots === 'string') {
                return `<p style="margin: 0.25rem 0;">${slots}</p>`;
            }

            if (Array.isArray(slots)) {
                return slots.map(slot => {
                    if (typeof slot === 'string') {
                        return `<p style="margin: 0.25rem 0;">${slot}</p>`;
                    }

                    const dayLabel = getDayLabel(slot.day);
                    const startTime = slot.start_time || '00:00';
                    const endTime = slot.end_time || '23:59';

                    return `<p style="margin: 0.25rem 0;">• ${dayLabel}: ${startTime} - ${endTime}</p>`;
                }).join('');
            }

            return '<p style="margin: 0.25rem 0;">Accès illimité 24h/24, 7j/7</p>';
        }

        function getDayLabel(day) {
            const labels = {
                'all': 'Tous les jours',
                'weekdays': 'Lun-Ven',
                'weekend': 'Sam-Dim',
                'monday': 'Lundi',
                'tuesday': 'Mardi',
                'wednesday': 'Mercredi',
                'thursday': 'Jeudi',
                'friday': 'Vendredi',
                'saturday': 'Samedi',
                'sunday': 'Dimanche'
            };
            return labels[day] || day;
        }

        function formatDate(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp * 1000);
            return date.toLocaleDateString('fr-FR');
        }

        function getStatusLabel(status) {
            const labels = {
                'active': 'Actif',
                'expired': 'Expiré',
                'cancelled': 'Annulé'
            };
            return labels[status] || status;
        }

        function isActive(subscription) {
            return subscription.is_active === true;
        }

        window.addEventListener('load', () => {
            loadSubscriptions();
        });
    </script>
</body>
</html>
