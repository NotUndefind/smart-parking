<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard Propriétaire - Smart Parking</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav>
        <div class="logo">Smart Parking - Propriétaire</div>
        <ul>
            <li><a href="owner-dashboard.html">Dashboard</a></li>
            <li><a href="#" id="logout-btn">Déconnexion</a></li>
        </ul>
    </nav>

    <div class="container">
        <div class="card">
            <h2>Bienvenue <span id="owner-name"></span></h2>
            <div id="alert-container"></div>
        </div>

        <div class="card">
            <h2>Mes parkings</h2>
            <button class="btn btn-primary" onclick="showCreateParkingForm()">
                Créer un nouveau parking
            </button>
            <div id="parkings-list" style="margin-top: 1rem;"></div>
        </div>

        <div class="card" id="create-parking-form" style="display: none;">
            <h2>Créer un parking</h2>
            <form id="parking-form">
                <div class="form-group">
                    <label for="nom">Nom du parking</label>
                    <input type="text" id="nom" required>
                </div>

                <div class="form-group">
                    <label for="adresse">Adresse</label>
                    <input type="text" id="adresse" required>
                </div>

                <div class="form-group">
                    <label for="latitude">Latitude</label>
                    <input type="number" step="0.000001" id="latitude" required>
                </div>

                <div class="form-group">
                    <label for="longitude">Longitude</label>
                    <input type="number" step="0.000001" id="longitude" required>
                </div>

                <div class="form-group">
                    <label for="nb_places">Nombre de places</label>
                    <input type="number" id="nb_places" required min="1">
                </div>

                <div class="form-group">
                    <label>Tarifs par tranche horaire</label>
                    <div style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem;">
                        <button type="button" id="generate-auto-tariffs-btn" class="btn btn-secondary">Générer tarifs automatiques</button>
                        <button type="button" id="add-tariff-btn" class="btn btn-secondary">+ Ajouter une tranche</button>
                    </div>
                    <div id="tariffs-container">
                        <div class="tariff-row" style="display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;">
                            <input type="number" class="tariff-duration" placeholder="Durée (min)" min="1" required style="flex: 1;">
                            <input type="number" class="tariff-price" placeholder="Prix (€)" step="0.01" min="0" required style="flex: 1;">
                            <button type="button" class="btn btn-secondary tariff-remove-btn" style="padding: 0.25rem 0.5rem;">✕</button>
                        </div>
                    </div>
                    <p style="font-size: 0.85rem; color: #666; margin-top: 0.5rem;">Astuce: Utilisez le bouton "Générer tarifs automatiques" pour créer une grille tarifaire par défaut (tranches de 15 min)</p>
                </div>

                <div class="form-group">
                    <label for="horaires">Horaires d'ouverture</label>
                    <input type="text" id="horaires" placeholder="Ex: 24h/24 ou Lun-Ven 8h-18h" required>
                </div>

                <button type="submit" class="btn btn-primary">Créer le parking</button>
                <button type="button" class="btn btn-secondary" onclick="hideCreateParkingForm()">Annuler</button>
            </form>
        </div>

        <div class="card" id="parking-details" style="display: none;">
            <h2 id="parking-title"></h2>
            <div id="parking-info"></div>

            <div style="margin-top: 2rem;">
                <button class="btn btn-primary" onclick="showUpdateTariffForm()">Modifier les tarifs</button>
                <button class="btn btn-primary" onclick="showUpdateScheduleForm()">Modifier les horaires</button>
                <button class="btn btn-primary" onclick="showAddSubscriptionForm()">Ajouter un abonnement</button>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Statistiques</h3>
                <div id="parking-stats"></div>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Réservations</h3>
                <div id="parking-reservations"></div>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Stationnements en cours</h3>
                <div id="parking-stationnements"></div>
            </div>

            <div style="margin-top: 2rem;">
                <h3>Dépassements de temps</h3>
                <div id="parking-overstays"></div>
            </div>

            <button class="btn btn-secondary" onclick="hideParkingDetails()">Retour à la liste</button>
        </div>

        <div class="card" id="update-tariff-form" style="display: none;">
            <h2>Modifier les tarifs</h2>
            <form id="tariff-form">
                <div class="form-group">
                    <label for="tariff_duration">Durée (minutes)</label>
                    <input type="number" id="tariff_duration" required min="1" value="60">
                </div>

                <div class="form-group">
                    <label for="tariff_price">Prix (€)</label>
                    <input type="number" step="0.01" id="tariff_price" required min="0">
                </div>

                <button type="submit" class="btn btn-primary">Mettre à jour les tarifs</button>
                <button type="button" class="btn btn-secondary" onclick="hideUpdateTariffForm()">Annuler</button>
            </form>
        </div>

        <div class="card" id="update-schedule-form" style="display: none;">
            <h2>Modifier les horaires</h2>
            <form id="schedule-form">
                <div class="form-group">
                    <label for="schedule_day">Jour</label>
                    <select id="schedule_day" required>
                        <option value="all">Tous les jours</option>
                        <option value="monday">Lundi</option>
                        <option value="tuesday">Mardi</option>
                        <option value="wednesday">Mercredi</option>
                        <option value="thursday">Jeudi</option>
                        <option value="friday">Vendredi</option>
                        <option value="saturday">Samedi</option>
                        <option value="sunday">Dimanche</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="schedule_hours">Horaires</label>
                    <input type="text" id="schedule_hours" placeholder="Ex: 24h/24 ou 8h-18h" required>
                </div>

                <button type="submit" class="btn btn-primary">Mettre à jour les horaires</button>
                <button type="button" class="btn btn-secondary" onclick="hideUpdateScheduleForm()">Annuler</button>
            </form>
        </div>

        <div class="card" id="add-subscription-form" style="display: none;">
            <h2>Ajouter un type d'abonnement</h2>
            <form id="subscription-form">
                <div class="form-group">
                    <label for="subscription_type">Type</label>
                    <select id="subscription_type" required>
                        <option value="monthly">Mensuel</option>
                        <option value="quarterly">Trimestriel</option>
                        <option value="yearly">Annuel</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="subscription_price">Prix (€)</label>
                    <input type="number" step="0.01" id="subscription_price" required min="0">
                </div>

                <div class="form-group">
                    <label for="subscription_duration">Durée (jours)</label>
                    <input type="number" id="subscription_duration" required min="1" value="30">
                </div>

                <div class="form-group">
                    <label for="subscription_description">Description (optionnel)</label>
                    <textarea id="subscription_description" rows="3"></textarea>
                </div>

                <button type="submit" class="btn btn-primary">Ajouter l'abonnement</button>
                <button type="button" class="btn btn-secondary" onclick="hideAddSubscriptionForm()">Annuler</button>
            </form>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        if (!authAPI.isAuthenticated() || !authAPI.isOwner()) {
            window.location.href = 'owner-login.html';
        }

        const owner = authAPI.getOwner();
        const alertContainer = document.getElementById('alert-container');

        document.getElementById('owner-name').textContent = owner?.first_name || owner?.nom || '';

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            authAPI.logout();
        });

        function showAlert(message, type = 'info') {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        function showCreateParkingForm() {
            document.getElementById('create-parking-form').style.display = 'block';

            // Attacher les event listeners maintenant que le formulaire est visible
            const generateBtn = document.getElementById('generate-auto-tariffs-btn');
            const addBtn = document.getElementById('add-tariff-btn');
            const tariffsContainer = document.getElementById('tariffs-container');

            if (generateBtn && !generateBtn.dataset.listenerAttached) {
                generateBtn.addEventListener('click', generateAutoTariffs);
                generateBtn.dataset.listenerAttached = 'true';
            }

            if (addBtn && !addBtn.dataset.listenerAttached) {
                addBtn.addEventListener('click', addTariff);
                addBtn.dataset.listenerAttached = 'true';
            }

            // Event delegation pour les boutons de suppression dynamiques
            if (tariffsContainer && !tariffsContainer.dataset.listenerAttached) {
                tariffsContainer.addEventListener('click', function(e) {
                    if (e.target.classList.contains('tariff-remove-btn')) {
                        removeTariff(e.target);
                    }
                });
                tariffsContainer.dataset.listenerAttached = 'true';
            }
        }

        function hideCreateParkingForm() {
            document.getElementById('create-parking-form').style.display = 'none';
            document.getElementById('parking-form').reset();
        }

        let currentParkingId = null;

        async function loadParkings() {
            try {
                const response = await fetch(`${API_BASE_URL}/owners/${owner.id}/parkings`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                displayParkings(data.parkings || []);
            } catch (error) {
                document.getElementById('parkings-list').innerHTML = '<p>Aucun parking créé pour le moment</p>';
            }
        }

        function displayParkings(parkings) {
            if (parkings.length === 0) {
                document.getElementById('parkings-list').innerHTML = '<p>Aucun parking créé pour le moment</p>';
                return;
            }

            const html = parkings.map(parking => `
                <div class="parking-card" style="margin-top: 1rem; padding: 1rem; background: #f8f9fa; border-radius: 4px;">
                    <h3>${parking.name || 'Parking'}</h3>
                    <p>${parking.address || ''}</p>
                    <p><strong>Places totales:</strong> ${parking.total_spots}</p>
                    <p><strong>Places disponibles:</strong> ${parking.available_spots}</p>
                    <button class="btn btn-primary" onclick="viewParkingDetails('${parking.id}')">
                        Voir les détails
                    </button>
                </div>
            `).join('');

            document.getElementById('parkings-list').innerHTML = html;
        }

        window.viewParkingDetails = async function(parkingId) {
            currentParkingId = parkingId;
            document.querySelector('.card:nth-child(2)').style.display = 'none';
            document.getElementById('parking-details').style.display = 'block';

            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${parkingId}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                const parking = data.parking;

                document.getElementById('parking-title').textContent = parking.nom || 'Parking';
                document.getElementById('parking-info').innerHTML = `
                    <p><strong>Adresse:</strong> ${parking.adresse}</p>
                    <p><strong>Places totales:</strong> ${parking.nb_places}</p>
                    <p><strong>Tarif horaire:</strong> ${parking.tarif_horaire}€</p>
                    <p><strong>Horaires:</strong> ${parking.horaires}</p>
                `;

                await loadParkingStats(parkingId);
                await loadParkingReservations(parkingId);
                await loadParkingStationnements(parkingId);
                await loadParkingOverstays(parkingId);
            } catch (error) {
                showAlert('Erreur lors du chargement des détails', 'error');
            }
        };

        async function loadParkingStats(parkingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${parkingId}/revenue?month=${new Date().getMonth() + 1}&year=${new Date().getFullYear()}`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();

                document.getElementById('parking-stats').innerHTML = `
                    <div style="display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 1rem;">
                        <div class="stat-card">
                            <h4>Chiffre d'affaires mensuel</h4>
                            <p style="font-size: 1.5rem; font-weight: bold; color: #27ae60;">
                                ${data.revenue || '0.00'}€
                            </p>
                        </div>
                        <div class="stat-card">
                            <h4>Réservations du mois</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">
                                ${data.reservations_count || 0}
                            </p>
                        </div>
                        <div class="stat-card">
                            <h4>Taux d'occupation</h4>
                            <p style="font-size: 1.5rem; font-weight: bold;">
                                ${data.occupation_rate || 0}%
                            </p>
                        </div>
                    </div>
                `;
            } catch (error) {
                document.getElementById('parking-stats').innerHTML = '<p>Statistiques non disponibles</p>';
            }
        }

        async function loadParkingReservations(parkingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${parkingId}/reservations`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                const reservations = data.reservations || [];

                if (reservations.length === 0) {
                    document.getElementById('parking-reservations').innerHTML = '<p>Aucune réservation</p>';
                    return;
                }

                const html = `
                    <table class="reservations-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Début</th>
                                <th>Fin</th>
                                <th>Statut</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${reservations.map(res => `
                                <tr>
                                    <td>${res.user_email || res.user_id}</td>
                                    <td>${formatDateTime(res.debut)}</td>
                                    <td>${formatDateTime(res.fin)}</td>
                                    <td>${res.statut}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('parking-reservations').innerHTML = html;
            } catch (error) {
                document.getElementById('parking-reservations').innerHTML = '<p>Aucune réservation</p>';
            }
        }

        async function loadParkingStationnements(parkingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${parkingId}/stationnements`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                const stationnements = data.stationnements || [];

                if (stationnements.length === 0) {
                    document.getElementById('parking-stationnements').innerHTML = '<p>Aucun stationnement en cours</p>';
                    return;
                }

                const html = `
                    <table class="reservations-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Heure d'entrée</th>
                                <th>Durée</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${stationnements.map(stat => `
                                <tr>
                                    <td>${stat.user_email || stat.user_id}</td>
                                    <td>${formatDateTime(stat.heure_entree)}</td>
                                    <td>${calculateDuration(stat.heure_entree)}</td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('parking-stationnements').innerHTML = html;
            } catch (error) {
                document.getElementById('parking-stationnements').innerHTML = '<p>Aucun stationnement en cours</p>';
            }
        }

        async function loadParkingOverstays(parkingId) {
            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${parkingId}/overstays`, {
                    headers: {
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    }
                });

                const data = await response.json();
                const overstays = data.overstays || [];

                if (overstays.length === 0) {
                    document.getElementById('parking-overstays').innerHTML = `
                        <p style="color: #27ae60;">Aucun dépassement de temps</p>
                    `;
                    return;
                }

                const html = `
                    <table class="reservations-table">
                        <thead>
                            <tr>
                                <th>Utilisateur</th>
                                <th>Entrée</th>
                                <th>Dépassement</th>
                                <th>Pénalité</th>
                            </tr>
                        </thead>
                        <tbody>
                            ${overstays.map(overstay => `
                                <tr style="background-color: #fff3cd;">
                                    <td>${overstay.user_email || overstay.user_id}</td>
                                    <td>${formatDateTime(overstay.heure_entree)}</td>
                                    <td style="color: #e74c3c; font-weight: bold;">
                                        ${calculateDuration(overstay.heure_entree)}
                                    </td>
                                    <td style="color: #e74c3c; font-weight: bold;">
                                        20.00€
                                    </td>
                                </tr>
                            `).join('')}
                        </tbody>
                    </table>
                `;

                document.getElementById('parking-overstays').innerHTML = html;
            } catch (error) {
                document.getElementById('parking-overstays').innerHTML = '<p>Aucun dépassement</p>';
            }
        }

        function hideParkingDetails() {
            document.getElementById('parking-details').style.display = 'none';
            document.querySelector('.card:nth-child(2)').style.display = 'block';
            currentParkingId = null;
        }

        function showUpdateTariffForm() {
            document.getElementById('parking-details').style.display = 'none';
            document.getElementById('update-tariff-form').style.display = 'block';
        }

        function hideUpdateTariffForm() {
            document.getElementById('update-tariff-form').style.display = 'none';
            document.getElementById('tariff-form').reset();
            document.getElementById('parking-details').style.display = 'block';
        }

        function showUpdateScheduleForm() {
            document.getElementById('parking-details').style.display = 'none';
            document.getElementById('update-schedule-form').style.display = 'block';
        }

        function hideUpdateScheduleForm() {
            document.getElementById('update-schedule-form').style.display = 'none';
            document.getElementById('schedule-form').reset();
            document.getElementById('parking-details').style.display = 'block';
        }

        function showAddSubscriptionForm() {
            document.getElementById('parking-details').style.display = 'none';
            document.getElementById('add-subscription-form').style.display = 'block';
        }

        function hideAddSubscriptionForm() {
            document.getElementById('add-subscription-form').style.display = 'none';
            document.getElementById('subscription-form').reset();
            document.getElementById('parking-details').style.display = 'block';
        }

        function formatDateTime(timestamp) {
            if (!timestamp) return 'N/A';
            const date = new Date(timestamp * 1000);
            return date.toLocaleString('fr-FR');
        }

        function calculateDuration(startTimestamp) {
            const now = Date.now();
            const start = startTimestamp * 1000;
            const diff = now - start;

            const hours = Math.floor(diff / (1000 * 60 * 60));
            const minutes = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));

            return `${hours}h ${minutes}min`;
        }

        window.generateAutoTariffs = function() {
            console.log('Génération des tarifs automatiques...');
            const container = document.getElementById('tariffs-container');

            if (!container) {
                console.error('Container not found!');
                return;
            }

            // Vider le container
            container.innerHTML = '';

            // Générer des tranches par paliers de 15 minutes jusqu'à 4 heures
            // Avec un tarif progressif: 0.40€ pour les premières 15min, puis augmentation progressive
            const tariffs = [
                { duration: 15, price: 0.40 },
                { duration: 30, price: 0.80 },
                { duration: 45, price: 1.20 },
                { duration: 60, price: 1.60 },
                { duration: 75, price: 2.00 },
                { duration: 90, price: 2.50 },
                { duration: 105, price: 3.00 },
                { duration: 120, price: 3.50 },
                { duration: 135, price: 4.00 },
                { duration: 150, price: 4.50 },
                { duration: 165, price: 5.00 },
                { duration: 180, price: 5.50 },
                { duration: 195, price: 6.00 },
                { duration: 210, price: 6.50 },
                { duration: 225, price: 7.00 },
                { duration: 240, price: 7.50 }
            ];

            tariffs.forEach(tariff => {
                const newRow = document.createElement('div');
                newRow.className = 'tariff-row';
                newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
                newRow.innerHTML = `
                    <input type="number" class="tariff-duration" value="${tariff.duration}" min="1" required style="flex: 1;">
                    <input type="number" class="tariff-price" value="${tariff.price.toFixed(2)}" step="0.01" min="0" required style="flex: 1;">
                    <button type="button" class="btn btn-secondary tariff-remove-btn" style="padding: 0.25rem 0.5rem;">✕</button>
                `;
                container.appendChild(newRow);
            });

            console.log(`${tariffs.length} tranches tarifaires générées`);

            if (typeof showAlert === 'function') {
                showAlert('Tarifs automatiques générés ! Vous pouvez les modifier.', 'success');
            }
        };

        window.addTariff = function() {
            const container = document.getElementById('tariffs-container');
            const newRow = document.createElement('div');
            newRow.className = 'tariff-row';
            newRow.style.cssText = 'display: flex; gap: 0.5rem; margin-bottom: 0.5rem; align-items: center;';
            newRow.innerHTML = `
                <input type="number" class="tariff-duration" placeholder="Durée (min)" min="1" required style="flex: 1;">
                <input type="number" class="tariff-price" placeholder="Prix (€)" step="0.01" min="0" required style="flex: 1;">
                <button type="button" class="btn btn-secondary tariff-remove-btn" style="padding: 0.25rem 0.5rem;">✕</button>
            `;
            container.appendChild(newRow);
        };

        window.removeTariff = function(button) {
            const container = document.getElementById('tariffs-container');
            if (container.children.length > 1) {
                button.parentElement.remove();
            } else {
                showAlert('Vous devez avoir au moins une tranche tarifaire', 'error');
            }
        };

        const parkingForm = document.getElementById('parking-form');
        parkingForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const horairesTexte = document.getElementById('horaires').value;

            // Récupérer tous les tarifs
            const tariffRows = document.querySelectorAll('.tariff-row');
            const tariffs = Array.from(tariffRows).map(row => {
                return {
                    duration: parseInt(row.querySelector('.tariff-duration').value),
                    price: parseFloat(row.querySelector('.tariff-price').value)
                };
            });

            const parkingData = {
                name: document.getElementById('nom').value,
                address: document.getElementById('adresse').value,
                latitude: parseFloat(document.getElementById('latitude').value),
                longitude: parseFloat(document.getElementById('longitude').value),
                total_spots: parseInt(document.getElementById('nb_places').value),
                tariffs: tariffs,
                schedule: [
                    {
                        day: 'all',
                        hours: horairesTexte
                    }
                ]
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parkings`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(parkingData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la création');
                }

                showAlert('Parking créé avec succès', 'success');
                hideCreateParkingForm();
                loadParkings();
            } catch (error) {
                showAlert(error.message || 'Erreur lors de la création du parking', 'error');
            }
        });

        const tariffForm = document.getElementById('tariff-form');
        tariffForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentParkingId) {
                showAlert('Erreur: parking non sélectionné', 'error');
                return;
            }

            const tariffData = {
                tariffs: [
                    {
                        duration: parseInt(document.getElementById('tariff_duration').value),
                        price: parseFloat(document.getElementById('tariff_price').value)
                    }
                ]
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${currentParkingId}/tariff`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(tariffData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la mise à jour');
                }

                showAlert('Tarifs mis à jour avec succès', 'success');
                hideUpdateTariffForm();
                viewParkingDetails(currentParkingId);
            } catch (error) {
                showAlert(error.message || 'Erreur lors de la mise à jour des tarifs', 'error');
            }
        });

        const scheduleForm = document.getElementById('schedule-form');
        scheduleForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentParkingId) {
                showAlert('Erreur: parking non sélectionné', 'error');
                return;
            }

            const scheduleData = {
                schedule: [
                    {
                        day: document.getElementById('schedule_day').value,
                        hours: document.getElementById('schedule_hours').value
                    }
                ]
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${currentParkingId}/schedule`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(scheduleData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de la mise à jour');
                }

                showAlert('Horaires mis à jour avec succès', 'success');
                hideUpdateScheduleForm();
                viewParkingDetails(currentParkingId);
            } catch (error) {
                showAlert(error.message || 'Erreur lors de la mise à jour des horaires', 'error');
            }
        });

        const subscriptionForm = document.getElementById('subscription-form');
        subscriptionForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentParkingId) {
                showAlert('Erreur: parking non sélectionné', 'error');
                return;
            }

            const subscriptionData = {
                type: document.getElementById('subscription_type').value,
                price: parseFloat(document.getElementById('subscription_price').value),
                duration: parseInt(document.getElementById('subscription_duration').value),
                description: document.getElementById('subscription_description').value || null
            };

            try {
                const response = await fetch(`${API_BASE_URL}/parkings/${currentParkingId}/subscription-types`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'Authorization': `Bearer ${localStorage.getItem('token')}`
                    },
                    body: JSON.stringify(subscriptionData)
                });

                const data = await response.json();

                if (!response.ok) {
                    throw new Error(data.error || 'Erreur lors de l\'ajout');
                }

                showAlert('Type d\'abonnement ajouté avec succès', 'success');
                hideAddSubscriptionForm();
                viewParkingDetails(currentParkingId);
            } catch (error) {
                showAlert(error.message || 'Erreur lors de l\'ajout du type d\'abonnement', 'error');
            }
        });

        window.addEventListener('load', () => {
            loadParkings();
        });
    </script>

    <style>
        .stat-card {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            text-align: center;
        }

        .stat-card h4 {
            margin: 0 0 0.5rem 0;
            font-size: 0.9rem;
            color: #666;
        }
    </style>
</body>
</html>
