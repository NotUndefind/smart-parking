<!DOCTYPE html>
<html lang="fr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Détails du parking - Smart Parking</title>
    <link rel="stylesheet" href="css/style.css">
</head>
<body>
    <nav>
        <div class="logo">Smart Parking</div>
        <ul>
            <li><a href="index.html">Rechercher</a></li>
            <li><a href="my-reservations.html">Mes réservations</a></li>
            <li><a href="#" id="logout-btn">Déconnexion</a></li>
        </ul>
    </nav>

    <div class="container">
        <div id="alert-container"></div>

        <div class="card" id="parking-details-card">
            <div id="loading" class="loading">
                <div class="spinner"></div>
                <p>Chargement...</p>
            </div>
        </div>

        <div class="card" id="reservation-card" style="display: none;">
            <h2>Réserver une place</h2>

            <form id="reservation-form">
                <div class="form-group">
                    <label for="start-date">Date et heure de début</label>
                    <input type="datetime-local" id="start-date" required>
                </div>

                <div class="form-group">
                    <label for="end-date">Date et heure de fin</label>
                    <input type="datetime-local" id="end-date" required>
                </div>

                <div id="price-estimate" class="alert alert-info" style="display: none;"></div>

                <button type="submit" class="btn btn-primary btn-block">
                    Confirmer la réservation
                </button>
            </form>
        </div>

        <div class="card" id="subscriptions-card" style="display: none;">
            <h2>Abonnements disponibles</h2>
            <div id="subscriptions-list"></div>
        </div>

        <div class="card" id="actions-card" style="display: none;">
            <h2>Actions rapides</h2>
            <button class="btn btn-primary btn-block" id="enter-btn">
                Entrer dans le parking
            </button>
            <div id="current-stationnement" style="margin-top: 1rem;"></div>
        </div>

        <div id="subscription-modal" class="modal" style="display: none;">
            <div class="modal-content">
                <span class="close" onclick="closeSubscriptionModal()">&times;</span>
                <h2 id="modal-subscription-title">Souscrire à un abonnement</h2>

                <form id="subscription-form">
                    <input type="hidden" id="subscription-type-id">

                    <div class="form-group">
                        <label for="subscription-duration">Durée de l'abonnement</label>
                        <select id="subscription-duration" required>
                            <option value="30">1 mois (30 jours)</option>
                            <option value="60">2 mois (60 jours)</option>
                            <option value="90">3 mois (90 jours)</option>
                            <option value="180">6 mois (180 jours)</option>
                            <option value="365">1 an (365 jours)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="subscription-start-date">Date de début</label>
                        <input type="date" id="subscription-start-date" required>
                    </div>

                    <div id="time-slots-section">
                        <h3>Créneaux horaires</h3>
                        <p style="color: #666; font-size: 0.9rem;">Définissez les créneaux hebdomadaires où vous aurez accès au parking</p>

                        <div id="time-slots-container">
                            <div class="time-slot-item">
                                <div class="form-group">
                                    <label>Jour(s)</label>
                                    <select class="slot-day">
                                        <option value="all">Tous les jours</option>
                                        <option value="weekdays">Lun-Ven</option>
                                        <option value="weekend">Sam-Dim</option>
                                        <option value="monday">Lundi</option>
                                        <option value="tuesday">Mardi</option>
                                        <option value="wednesday">Mercredi</option>
                                        <option value="thursday">Jeudi</option>
                                        <option value="friday">Vendredi</option>
                                        <option value="saturday">Samedi</option>
                                        <option value="sunday">Dimanche</option>
                                    </select>
                                </div>
                                <div class="form-group">
                                    <label>Heure de début</label>
                                    <input type="time" class="slot-start" value="00:00">
                                </div>
                                <div class="form-group">
                                    <label>Heure de fin</label>
                                    <input type="time" class="slot-end" value="23:59">
                                </div>
                            </div>
                        </div>

                        <button type="button" class="btn btn-secondary" onclick="addTimeSlot()">
                            Ajouter un créneau
                        </button>
                    </div>

                    <div id="subscription-price-estimate" class="alert alert-info" style="margin-top: 1rem;">
                        Prix estimé: <strong id="estimated-price">0.00</strong>€
                    </div>

                    <div style="display: flex; gap: 1rem; margin-top: 1rem;">
                        <button type="submit" class="btn btn-primary" style="flex: 1;">
                            Confirmer l'abonnement
                        </button>
                        <button type="button" class="btn btn-secondary" onclick="closeSubscriptionModal()" style="flex: 1;">
                            Annuler
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="js/api.js"></script>
    <script>
        if (!authAPI.isAuthenticated()) {
            window.location.href = 'login.html';
        }

        const user = authAPI.getUser();
        const alertContainer = document.getElementById('alert-container');
        const parkingDetailsCard = document.getElementById('parking-details-card');
        const reservationCard = document.getElementById('reservation-card');
        const subscriptionsCard = document.getElementById('subscriptions-card');
        const actionsCard = document.getElementById('actions-card');
        const loadingDiv = document.getElementById('loading');

        document.getElementById('logout-btn').addEventListener('click', (e) => {
            e.preventDefault();
            authAPI.logout();
        });

        function showAlert(message, type = 'info') {
            alertContainer.innerHTML = `<div class="alert alert-${type}">${message}</div>`;
            setTimeout(() => alertContainer.innerHTML = '', 5000);
        }

        const urlParams = new URLSearchParams(window.location.search);
        const parkingId = urlParams.get('id');

        if (!parkingId) {
            showAlert('Aucun parking sélectionné', 'error');
            setTimeout(() => window.location.href = 'index.html', 2000);
        }

        let currentParking = null;

        async function loadParkingDetails() {
            try {
                console.log('Chargement détails parking:', parkingId);
                const data = await parkingAPI.getDetails(parkingId);
                console.log('Réponse API:', data);
                
                if (!data || !data.parking) {
                    console.error('Réponse API invalide:', data);
                    throw new Error('Parking non trouvé dans la réponse');
                }
                
                currentParking = data.parking;
                console.log('Parking chargé:', currentParking);
                displayParkingDetails(currentParking);

                reservationCard.style.display = 'block';
                actionsCard.style.display = 'block';

                await loadSubscriptions();
                await loadCurrentStationnement();
            } catch (error) {
                console.error('Erreur chargement détails:', error);
                console.error('Stack:', error.stack);
                // Fallback : utiliser les données par défaut si l'API échoue
                const defaultParking = {
                    id: parkingId || 'parking_demo_user',
                    nom: 'Parking Démo',
                    adresse: '10 Rue de la Démo, 75000 Paris',
                    nb_places: 50,
                    places_disponibles: 50,
                    tarif_horaire: 2.0,
                    latitude: 48.8566,
                    longitude: 2.3522,
                    horaires: '24h/24'
                };
                currentParking = defaultParking;
                displayParkingDetails(defaultParking);
                reservationCard.style.display = 'block';
                actionsCard.style.display = 'block';
                showAlert('Données par défaut affichées (API indisponible: ' + error.message + ')', 'info');
            } finally {
                loadingDiv.style.display = 'none';
            }
        }

        function displayParkingDetails(parking) {
            parkingDetailsCard.innerHTML = `
                <h2>${parking.nom || 'Parking'}</h2>
                <div style="margin-top: 1rem;">
                    <p><strong>Adresse:</strong> ${parking.adresse || 'Non disponible'}</p>
                    <p><strong>Places totales:</strong> ${parking.nb_places || 'N/A'}</p>
                    <p><strong>Places disponibles:</strong> <span id="available-spots">${parking.places_disponibles || parking.nb_places || 'N/A'}</span></p>
                    <p><strong>Tarif horaire:</strong> ${parking.tarif_horaire || '2.50'}€/h</p>
                    <p><strong>Coordonnées GPS:</strong> ${parking.latitude || 'N/A'}, ${parking.longitude || 'N/A'}</p>
                    <p><strong>Horaires:</strong> ${parking.horaires || '24h/24'}</p>
                </div>
            `;
        }

        async function loadSubscriptions() {
            try {
                const data = await parkingAPI.getSubscriptions(parkingId);
                if (data.subscriptions && data.subscriptions.length > 0) {
                    subscriptionsCard.style.display = 'block';
                    displaySubscriptions(data.subscriptions);
                }
            } catch (error) {
                console.error('Erreur chargement abonnements:', error);
            }
        }

        async function loadCurrentStationnement() {
            try {
                if (!user || !user.id) {
                    console.log('User not authenticated, skipping current stationnement load');
                    return;
                }
                const stationnementsResponse = await stationnementAPI.getUserStationnements(user.id);
                const stationnements = stationnementsResponse.stationnements || [];
                const currentStationnement = stationnements.find(s => !s.heure_sortie && s.parking_id === parkingId);

                if (currentStationnement) {
                    const entryDate = new Date(currentStationnement.heure_entree * 1000);
                    const now = Date.now();
                    const duration = Math.floor((now - entryDate.getTime()) / (1000 * 60));
                    const hours = Math.floor(duration / 60);
                    const minutes = duration % 60;
                    const tarif = currentParking.tarif_horaire || 2.50;
                    const estimatedCost = ((now - entryDate.getTime()) / (1000 * 60 * 60) * tarif).toFixed(2);

                    document.getElementById('current-stationnement').innerHTML = `
                        <div class="alert alert-success">
                            <h3>${currentParking.nom || 'Parking'}</h3>
                            <p><strong>Entrée:</strong> ${entryDate.toLocaleString('fr-FR')}</p>
                            <p><strong>Durée:</strong> ${hours}h ${minutes}min</p>
                            <p><strong>Coût estimé:</strong> ${estimatedCost}€</p>
                            <a href="my-stationnements.html" class="btn btn-secondary" style="margin-top: 0.5rem;">
                                Voir mes stationnements
                            </a>
                        </div>
                    `;
                } else {
                    console.log('Active stationnement not found');
                }
            } catch (error) {
                console.error('Erreur chargement stationnement actif:', error);
            }
        }

        function displaySubscriptions(subscriptions) {
            const html = subscriptions.map(sub => `
                <div class="parking-card" style="margin-bottom: 1rem;">
                    <h3>${getSubscriptionTypeName(sub.type || sub.nom)}</h3>
                    <p style="color: #666;">${sub.description || getSubscriptionDescription(sub.type)}</p>
                    <p><strong>Prix:</strong> ${sub.prix || sub.price || 'N/A'}€/${getDurationLabel(sub.duration || sub.duree || 30)}</p>
                    <p><strong>Durée:</strong> ${getDurationLabel(sub.duration || sub.duree || 30)}</p>
                    <p><strong>Créneaux:</strong> ${formatTimeSlots(sub.time_slots || sub.creneaux)}</p>
                    <button class="btn btn-primary" onclick="showSubscriptionModal('${sub.id}', '${sub.type || sub.nom}')">
                        Souscrire
                    </button>
                </div>
            `).join('');

            document.getElementById('subscriptions-list').innerHTML = html;
        }

        function getSubscriptionTypeName(type) {
            const types = {
                'monthly': 'Abonnement Mensuel Total',
                'weekend': 'Abonnement Week-end',
                'evening': 'Abonnement Soirée',
                'custom': 'Abonnement Personnalisé',
                'quarterly': 'Abonnement Trimestriel',
                'yearly': 'Abonnement Annuel'
            };
            return types[type] || type || 'Abonnement';
        }

        function getSubscriptionDescription(type) {
            const descriptions = {
                'monthly': 'Accès illimité à une place de parking à n\'importe quelle heure pendant 1 mois',
                'weekend': 'Accès du vendredi 18h au lundi 10h chaque semaine',
                'evening': 'Accès tous les soirs de 18h à 8h du matin le lendemain',
                'custom': 'Créneaux horaires personnalisés selon vos besoins',
                'quarterly': 'Accès illimité pendant 3 mois',
                'yearly': 'Accès illimité pendant 1 an'
            };
            return descriptions[type] || '';
        }

        function getDurationLabel(days) {
            if (days >= 365) return `${Math.floor(days / 365)} an(s)`;
            if (days >= 90) return `${Math.floor(days / 30)} mois`;
            if (days >= 30) return '1 mois';
            return `${days} jours`;
        }

        function formatTimeSlots(slots) {
            if (!slots) return 'Accès illimité 24h/24';
            if (typeof slots === 'string') return slots;
            if (Array.isArray(slots)) {
                return slots.map(slot => {
                    if (typeof slot === 'string') return slot;
                    return `${slot.day || 'Tous les jours'}: ${slot.start_time || '00:00'} - ${slot.end_time || '23:59'}`;
                }).join(', ');
            }
            return 'Accès illimité 24h/24';
        }

        const reservationForm = document.getElementById('reservation-form');
        const startDateInput = document.getElementById('start-date');
        const endDateInput = document.getElementById('end-date');
        const priceEstimate = document.getElementById('price-estimate');

        function calculateEstimate() {
            const start = new Date(startDateInput.value);
            const end = new Date(endDateInput.value);

            if (!start || !end || end <= start) {
                priceEstimate.style.display = 'none';
                return;
            }

            const hours = (end - start) / (1000 * 60 * 60);
            const tarif = currentParking?.tarif_horaire || 2.50;
            const estimate = (hours * tarif).toFixed(2);

            priceEstimate.style.display = 'block';
            priceEstimate.textContent = `Estimation: ${estimate}€ pour ${hours.toFixed(1)}h`;
        }

        startDateInput.addEventListener('change', calculateEstimate);
        endDateInput.addEventListener('change', calculateEstimate);

        reservationForm.addEventListener('submit', async (e) => {
            e.preventDefault();

            const startDate = new Date(startDateInput.value);
            const endDate = new Date(endDateInput.value);

            if (endDate <= startDate) {
                showAlert('La date de fin doit être après la date de début', 'error');
                return;
            }

            try {
                await reservationAPI.create({
                    user_id: user.id,
                    parking_id: parkingId,
                    start_time: Math.floor(startDate.getTime() / 1000),
                    end_time: Math.floor(endDate.getTime() / 1000)
                });

                showAlert('Réservation créée avec succès', 'success');
                setTimeout(() => window.location.href = 'my-reservations.html', 2000);
            } catch (error) {
                showAlert(error.message || 'Erreur lors de la réservation', 'error');
            }
        });

        document.getElementById('enter-btn').addEventListener('click', async () => {
            try {
                // Trouver une réservation active pour ce parking
                const reservationsResponse = await reservationAPI.getUserReservations(user.id);
                const reservations = reservationsResponse.reservations || [];
                const now = Math.floor(Date.now() / 1000);

                const activeReservation = reservations.find(r =>
                    r.parking_id === parkingId &&
                    r.statut === 'active' &&
                    r.debut <= now &&
                    r.fin >= now
                );

                if (!activeReservation) {
                    showAlert('Aucune réservation active trouvée pour ce parking', 'error');
                    return;
                }

                const data = await parkingAPI.enter(parkingId, activeReservation.id);
                showAlert('Entrée enregistrée avec succès', 'success');

                // Récupérer les détails du stationnement
                const stationnementsResponse = await stationnementAPI.getUserStationnements(user.id);
                const stationnements = stationnementsResponse.stationnements || [];
                const currentStationnement = stationnements.find(s => !s.heure_sortie && s.parking_id === parkingId);

                if (currentStationnement) {
                    const entryDate = new Date(currentStationnement.heure_entree * 1000);
                    const now = Date.now();
                    const duration = Math.floor((now - entryDate.getTime()) / (1000 * 60));
                    const hours = Math.floor(duration / 60);
                    const minutes = duration % 60;
                    const tarif = currentParking.tarif_horaire || 2.50;
                    const estimatedCost = ((now - entryDate.getTime()) / (1000 * 60 * 60) * tarif).toFixed(2);

                    document.getElementById('current-stationnement').innerHTML = `
                        <div class="alert alert-success">
                            <h3>${currentParking.nom || 'Parking'}</h3>
                            <p><strong>Entrée:</strong> ${entryDate.toLocaleString('fr-FR')}</p>
                            <p><strong>Durée:</strong> ${hours}h ${minutes}min</p>
                            <p><strong>Coût estimé:</strong> ${estimatedCost}€</p>
                            <a href="my-stationnements.html" class="btn btn-secondary" style="margin-top: 0.5rem;">
                                Voir mes stationnements
                            </a>
                        </div>
                    `;
                } else {
                    document.getElementById('current-stationnement').innerHTML = `
                        <div class="alert alert-success">
                            <p><strong>Stationnement en cours</strong></p>
                            <p>Début: ${new Date().toLocaleString('fr-FR')}</p>
                            <a href="my-stationnements.html" class="btn btn-secondary" style="margin-top: 0.5rem;">
                                Voir mes stationnements
                            </a>
                        </div>
                    `;
                }
            } catch (error) {
                showAlert(error.message || 'Erreur lors de l\'entrée', 'error');
            }
        });

        let currentSubscriptionTypeId = null;
        let currentSubscriptionType = null;

        window.showSubscriptionModal = function(subscriptionId, subscriptionType) {
            currentSubscriptionTypeId = subscriptionId;
            currentSubscriptionType = subscriptionType;

            document.getElementById('subscription-type-id').value = subscriptionId;
            document.getElementById('modal-subscription-title').textContent = `Souscrire à ${getSubscriptionTypeName(subscriptionType)}`;

            const today = new Date().toISOString().split('T')[0];
            document.getElementById('subscription-start-date').value = today;
            document.getElementById('subscription-start-date').min = today;

            document.getElementById('subscription-modal').style.display = 'flex';
        };

        window.closeSubscriptionModal = function() {
            document.getElementById('subscription-modal').style.display = 'none';
            document.getElementById('subscription-form').reset();
            currentSubscriptionTypeId = null;
            currentSubscriptionType = null;
        };

        window.addTimeSlot = function() {
            const container = document.getElementById('time-slots-container');
            const newSlot = document.createElement('div');
            newSlot.className = 'time-slot-item';
            newSlot.innerHTML = `
                <div class="form-group">
                    <label>Jour(s)</label>
                    <select class="slot-day">
                        <option value="all">Tous les jours</option>
                        <option value="weekdays">Lun-Ven</option>
                        <option value="weekend">Sam-Dim</option>
                        <option value="monday">Lundi</option>
                        <option value="tuesday">Mardi</option>
                        <option value="wednesday">Mercredi</option>
                        <option value="thursday">Jeudi</option>
                        <option value="friday">Vendredi</option>
                        <option value="saturday">Samedi</option>
                        <option value="sunday">Dimanche</option>
                    </select>
                </div>
                <div class="form-group">
                    <label>Heure de début</label>
                    <input type="time" class="slot-start" value="00:00">
                </div>
                <div class="form-group">
                    <label>Heure de fin</label>
                    <input type="time" class="slot-end" value="23:59">
                </div>
                <button type="button" class="btn btn-danger btn-small" onclick="removeTimeSlot(this)">Supprimer</button>
            `;
            container.appendChild(newSlot);
        };

        window.removeTimeSlot = function(button) {
            button.parentElement.remove();
        };

        document.getElementById('subscription-form').addEventListener('submit', async (e) => {
            e.preventDefault();

            if (!currentSubscriptionTypeId) {
                showAlert('Erreur: type d\'abonnement non sélectionné', 'error');
                return;
            }

            const duration = parseInt(document.getElementById('subscription-duration').value);
            const startDate = new Date(document.getElementById('subscription-start-date').value);

            const timeSlots = [];
            document.querySelectorAll('.time-slot-item').forEach(item => {
                const day = item.querySelector('.slot-day').value;
                const startTime = item.querySelector('.slot-start').value;
                const endTime = item.querySelector('.slot-end').value;

                timeSlots.push({
                    day: day,
                    start_time: startTime,
                    end_time: endTime
                });
            });

            // Calculer la date de fin en fonction de la durée
            const endDate = new Date(startDate);
            endDate.setDate(endDate.getDate() + duration);

            const subscriptionData = {
                parking_id: parkingId,
                type: currentSubscriptionType,
                start_date: Math.floor(startDate.getTime() / 1000),
                end_date: Math.floor(endDate.getTime() / 1000),
                time_slots: timeSlots
            };

            try {
                await subscriptionAPI.subscribe(subscriptionData);

                showAlert('Abonnement souscrit avec succès', 'success');
                closeSubscriptionModal();
                setTimeout(() => window.location.href = 'my-subscriptions.html', 2000);
            } catch (error) {
                showAlert(error.message || 'Erreur lors de la souscription', 'error');
            }
        });

        // Charger les détails au démarrage
        if (parkingId) {
            loadParkingDetails();
        } else {
            loadingDiv.style.display = 'none';
            showAlert('Aucun parking sélectionné', 'error');
        }
    </script>

    <style>
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.5);
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background-color: #fff;
            padding: 2rem;
            border-radius: 8px;
            max-width: 600px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
            position: relative;
        }

        .close {
            position: absolute;
            top: 1rem;
            right: 1.5rem;
            font-size: 2rem;
            font-weight: bold;
            color: #666;
            cursor: pointer;
        }

        .close:hover {
            color: #000;
        }

        .time-slot-item {
            background: #f8f9fa;
            padding: 1rem;
            border-radius: 4px;
            margin-bottom: 1rem;
            display: grid;
            grid-template-columns: 1fr 1fr 1fr;
            gap: 1rem;
        }

        .time-slot-item button {
            grid-column: 1 / -1;
            margin-top: 0.5rem;
        }

        .btn-small {
            padding: 0.5rem 1rem;
            font-size: 0.875rem;
        }

        .btn-danger {
            background-color: #e74c3c;
        }

        .btn-danger:hover {
            background-color: #c0392b;
        }

        #time-slots-section {
            margin-top: 1.5rem;
            padding-top: 1.5rem;
            border-top: 1px solid #ddd;
        }

        #time-slots-section h3 {
            margin-bottom: 0.5rem;
        }
    </style>
</body>
</html>
